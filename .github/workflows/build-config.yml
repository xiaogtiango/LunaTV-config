name: Build Filtered JSON

on:
  push:
    paths:
      - "LunaTV-config.json"
  workflow_dispatch:

jobs:
  build-json:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # ---- Step 1: åˆ é™¤å«æœ‰ _comment å­—æ®µçš„æ•°æ®ç»„ ----
      - name: Generate jingjian.json (strip _comment)
        run: |
          jq '{
            cache_time: .cache_time,
            api_site: (
              .api_site
              | with_entries(select(.value._comment | not))
            )
          }' LunaTV-config.json > jingjian.json

      # ---- Step 2: éªŒè¯ JSON æ–‡ä»¶æ ¼å¼ ----
      - name: Validate jingjian.json
        run: jq empty jingjian.json

      # ---- Step 3: åˆ é™¤æ‰€æœ‰ name ä¸­å¸¦ "ğŸ”" çš„æ•°æ®ç»„ ----
      - name: Generate jin18.json (strip adult resources)
        run: |
          jq '{
            cache_time: .cache_time,
            api_site: (
              .api_site
              | with_entries(select(.value.name | startswith("ğŸ”") | not))
            )
          }' jingjian.json > jin18.json

      - name: Validate jin18.json
        run: jq empty jin18.json

      # ---- æäº¤è‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶ ----
      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add jingjian.json jin18.json
          git commit -m "Auto-generate jingjian.json & jin18.json" || echo "Nothing to commit"
          git push
