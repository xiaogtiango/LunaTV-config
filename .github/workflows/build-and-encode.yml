name: Build and Encode JSON

on:
  push:
    paths:
      - 'LunaTV-config.json'
  workflow_dispatch:

jobs:
  build-and-encode:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # å…è®¸æ¨é€

    steps:
      # 1ï¸âƒ£ æ£€å‡ºä»“åº“
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y nodejs
          npm install bs58

      # ---- Step 1: åˆ é™¤å«æœ‰ _comment å­—æ®µçš„æ•°æ®ç»„ï¼Œç”Ÿæˆ jingjian.json ----
      - name: Generate jingjian.json (strip _comment)
        run: |
          jq '{
            cache_time: .cache_time,
            api_site: (
              .api_site
              | with_entries(select(.value._comment | not))
            )
          }' LunaTV-config.json > jingjian.json

      # ---- Step 2: éªŒè¯ jingjian.json ----
      - name: Validate jingjian.json
        run: jq empty jingjian.json

      # ---- Step 3: åˆ é™¤ name ä¸­å« "ğŸ”" çš„æ•°æ®ç»„ï¼Œç”Ÿæˆ jin18.json ----
      - name: Generate jin18.json (strip adult resources)
        run: |
          jq '{
            cache_time: .cache_time,
            api_site: (
              .api_site
              | with_entries(select(.value.name | startswith("ğŸ”") | not))
            )
          }' jingjian.json > jin18.json

      - name: Validate jin18.json
        run: jq empty jin18.json

      # ---- Step 4: Base58 ç¼–ç æ‰€æœ‰ JSON æ–‡ä»¶ ----
      - name: Encode JSON to Base58
        run: |
          cat > encode.js <<'EOF'
          const fs = require('fs');
          const bs58 = require('bs58');

          const files = [
            { input: 'LunaTV-config.json', output: 'LunaTV-config.txt' },
            { input: 'jingjian.json', output: 'jingjian.txt' },
            { input: 'jin18.json', output: 'jin18.txt' }
          ];

          files.forEach(file => {
            if (!fs.existsSync(file.input)) {
              console.log(`âš ï¸ æ–‡ä»¶ä¸å­˜åœ¨: ${file.input}`);
              return;
            }

            const data = fs.readFileSync(file.input);
            const encoded = bs58.encode(Buffer.from(data));
            fs.writeFileSync(file.output, encoded);
            console.log(`âœ… å·²ç”Ÿæˆ Base58 æ–‡ä»¶: ${file.output}`);
          });
          EOF

          node encode.js

      # ---- Step 5: æäº¤å¹¶æ¨é€æ‰€æœ‰ç”Ÿæˆæ–‡ä»¶ ----
      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add jingjian.json jin18.json LunaTV-config.txt jingjian.txt jin18.txt
          git commit -m "Auto-generate filtered JSON & Base58 encoded files" || echo "No changes"
          git push
